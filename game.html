<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>古文単語 タイムアタック ランキングバトル</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f0f8ff; margin: 0; padding: 20px 0; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; background-color: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #005f73; }
        
        .hidden { display: none; }

        #question-word { font-size: 2.5em; font-weight: bold; margin: 20px 0; color: #005f73; }
        .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .choice-btn { width: 100%; min-height: 80px; font-size: 1.1em; border: 2px solid #94d2bd; background-color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .choice-btn:hover { background-color: #e9d8a6; }
        .choice-btn.correct { background-color: #a7c957; color: white; border-color: #a7c957; }
        .choice-btn.wrong { background-color: #f28482; color: white; border-color: #f28482; }

        #info { display: flex; justify-content: space-between; font-size: 1.5em; margin: 20px 0; }
        #start-btn, #retry-btn { font-size: 1.5em; padding: 15px 30px; cursor: pointer; background-color: #0a9396; color: white; border: none; border-radius: 5px; margin-top: 20px;}
        #result-text { font-size: 1.5em; margin-bottom: 30px;}
        
        /* ランキングテーブルのスタイル */
        #ranking-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #ranking-table th, #ranking-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        #ranking-table th { background-color: #e9d8a6; color: #333; }
        #ranking-table tr:nth-child(odd) { background-color: #f9f9f9; }
    </style>
</head>
<body>

    <div class="container">
        <div id="start-screen">
            <h1>古文単語 タイムアタック</h1>
            <p>10問連続で出題されます。全問正解までのタイムを競え！</p>
            <button id="start-btn">スタート！</button>
        </div>

        <div id="game-screen" class="hidden">
            <div id="info">
                <span id="question-number"></span>
                <span id="timer">0.00 秒</span>
            </div>
            <div id="question-word"></div>
            <div class="choices">
                <button class="choice-btn"></button>
                <button class="choice-btn"></button>
                <button class="choice-btn"></button>
                <button class="choice-btn"></button>
            </div>
        </div>

        <div id="result-screen" class="hidden">
            <h1>結果発表</h1>
            <p id="result-text"></p>
            
            <h2>ランキング</h2>
            <table id="ranking-table">
                <thead>
                    <tr><th>順位</th><th>名前</th><th>タイム</th><th>正解数</th></tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            
            <button id="retry-btn">もう一度挑戦する</button>
        </div>
    </div>

    <script src="words.js"></script> 
    
    <script>
        // --- 設定 ---
        const TOTAL_QUESTIONS = 10; 

        // --- HTML要素の取得 ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const startBtn = document.getElementById('start-btn');
        const retryBtn = document.getElementById('retry-btn');
        const questionNumberEl = document.getElementById('question-number');
        const timerEl = document.getElementById('timer');
        const questionWordEl = document.getElementById('question-word');
        const choiceBtns = document.querySelectorAll('.choice-btn');
        const resultTextEl = document.getElementById('result-text');

        // --- ゲームの状態を管理する変数 ---
        let questions = []; 
        let currentQIndex = 0; 
        let score = 0;
        let timerInterval;
        let startTime;

        // --- イベントリスナー ---
        startBtn.addEventListener('click', startGame);
        retryBtn.addEventListener('click', startGame);

        // --- ゲームのロジック ---

        /**
         * 配列をシャッフルするヘルパー関数 
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * ゲームを開始する関数
         */
        function startGame() {
            if (kobunWords.length < 4) {
                 alert("問題が少なすぎます。words.jsに最低4つ以上の単語を追加してください。");
                 return;
            }
            currentQIndex = 0;
            score = 0;
            
            questions = shuffleArray([...kobunWords]).slice(0, TOTAL_QUESTIONS);

            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 10);
            
            showQuestion();
        }

        /**
         * 問題を表示する関数（ダミー選択肢を動的に生成）
         */
        function showQuestion() {
            choiceBtns.forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = false;
            });

            const q = questions[currentQIndex];

            questionWordEl.textContent = q.word;
            questionNumberEl.textContent = `第 ${currentQIndex + 1} 問`;

            const correctAnswer = q.answer;
            
            // 1. 他の単語の答えを全て取得し、正解の答えを除く
            const allOtherAnswers = kobunWords
                .map(item => item.answer) 
                .filter(answer => answer !== correctAnswer); 

            // 2. 他の答えをシャッフルして、3つだけ取り出す
            const dummyChoices = shuffleArray(allOtherAnswers).slice(0, 3);
            
            // 3. 正解とダミー選択肢を結合し、再度シャッフルして最終的な選択肢リストを作る
            const finalChoices = shuffleArray([correctAnswer, ...dummyChoices]);

            // 4. ボタンに選択肢を割り当てる
            choiceBtns.forEach((btn, index) => {
                btn.textContent = finalChoices[index];
                btn.onclick = (event) => checkAnswer(event, correctAnswer);
            });
        }

        /**
         * 答えをチェックする関数
         */
        function checkAnswer(event, correctAnswer) {
            const clickedBtn = event.target;
            const clickedAnswer = clickedBtn.textContent;

            choiceBtns.forEach(btn => btn.disabled = true);

            if (clickedAnswer === correctAnswer) {
                clickedBtn.classList.add('correct');
                score++;
            } else {
                clickedBtn.classList.add('wrong');
                choiceBtns.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }

            setTimeout(() => {
                currentQIndex++;
                if (currentQIndex < TOTAL_QUESTIONS) {
                    showQuestion();
                } else {
                    endGame();
                }
            }, 1000);
        }

        /**
         * ゲームを終了する関数 (ランキング連携処理を含む)
         */
        function endGame() {
            clearInterval(timerInterval);
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(2);

            resultTextEl.innerHTML = `正解数: ${score} / ${TOTAL_QUESTIONS} 問<br>クリアタイム: ${elapsedTime} 秒`;
            
            gameScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');

            // --- ランキング登録処理 ---
            const playerName = prompt("あなたの名前を入力してください（ランキング登録用）:");
            if (playerName) {
                sendScoreToRanking(playerName, elapsedTime, score);
            }
            
            // ランキングを読み込んで表示
            displayRanking();
        }

        /**
         * タイマーを更新する関数
         */
        function updateTimer() {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(2);
            timerEl.textContent = `${elapsedTime} 秒`;
        }

        /**
         * スコアをGASに送信する関数
         */
        function sendScoreToRanking(name, time, score) {
            // ★重要★ ここにメモしたGASのウェブアプリURLを貼り付ける
            const GAS_URL = "https://script.google.com/macros/s/AKfycbztBY7TZfhLLI7rz-0kLMEJ18HHUgpzHjlqvc_CuNRti9KDZfVDUCnceKn48iRhYfKU/exec"; 

            const dataToSend = {
                name: name,
                time: time,
                score: score
            };

            fetch(GAS_URL, {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    console.log("スコア登録成功！");
                    displayRanking(); 
                }
            })
            .catch(error => {
                console.error("スコア登録エラー:", error);
                // エラー時もランキング表示を試みる
                displayRanking(); 
            });
        }
        
        /**
         * ランキングを取得・表示する関数
         */
        function displayRanking() {
            // ★重要★ ここにメモしたGASのウェブアプリURLを貼り付ける
            const GAS_URL = "https://script.google.com/macros/s/AKfycbztBY7TZfhLLI7rz-0kLMEJ18HHUgpzHjlqvc_CuNRti9KDZfVDUCnceKn48iRhYfKU/exec";
            const tableBody = document.querySelector('#ranking-table tbody');
            
            tableBody.innerHTML = '<tr><td colspan="4">ランキング読み込み中...</td></tr>';

            fetch(GAS_URL, {
                method: 'GET' 
            })
            .then(response => response.json())
            .then(rankingData => {
                tableBody.innerHTML = ''; 

                // 上位10件のみ表示
                rankingData.slice(0, 10).forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${row[0]}</td>
                        <td>${row[1]}秒</td>
                        <td>${row[2]}問</td>
                    `;
                    tableBody.appendChild(tr);
                });
            })
            .catch(error => {
                tableBody.innerHTML = '<tr><td colspan="4">ランキングの取得に失敗しました。GASのURLが正しいか確認してください。</td></tr>';
                console.error("ランキング取得エラー:", error);
            });
        }

    </script>
</body>

</html>
